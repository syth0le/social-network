## Отказоустойчивость приложений
## Цель:
Поднять несколько слейвов MySQL.
Реализовать соединение со слейвами mysql через haproxy.
Поднять несколько приложений и обеспечить их балансировку через nginx.
Воспроизвести нагрузку.
Под нагрузкой с помощью "kill -9" отключить один из слейвов MySQL. Убедится, что система осталась работоспособной.
Под нагрузкой с помощью "kill -9" отключить один из инстансов бэкенда. Убедится, что система осталась работоспособной

## Реализация:
- описано дополнительные контейнеры в [docker compose](https://github.com/syth0le/social-network/blob/main/docker-compose.yaml#L4):
  - 2 контейнера с приложением 
  - 1 контейнер с nginx
  - 1 контейнер с haproxy
- описана [конфигурация для nginx](https://github.com/syth0le/social-network/blob/main/infra/nginx/nginx.conf):
  - описан апстрим для http
  - апстрим для grpc
  - во всех апстримах по 3 контейнера, нагрузку между которыми nginx размазывает с помощью простого round robin

Результаты нагрузочного теста:
- вышло так, что нужно верно настраивать нгинкс для лучшего результата ответа сервера.
- при работе было выявлено что с нгинксом время ответа увеличилось изначально в 2 раза
- результат тестирования 1го контейнера без нгинкса (напрямую)
  ```sql
   bombardier -c 125 -d 10s "localhost:8080/user/snwu981936fee1f249f098965c6102f6e5f3"
  
  Statistics        Avg      Stdev        Max
  Reqs/sec      1827.18     848.45    4600.04
  Latency       68.33ms    67.03ms   447.35ms
  ```
- результат тестирования c поднятым нгинксом и 3мя  без нгинкса (напрямую)
  ```sql
   bombardier -c 125 -d 10s "localhost:80/user/snwu981936fee1f249f098965c6102f6e5f3"

  Statistics        Avg      Stdev        Max
  Reqs/sec       606.08     463.80    2773.29
  Latency      207.31ms   278.54ms      1.58s
  
  ```
  существенно просели результаты из-за неверной настройки нгинкcа
- после более глубокой настройки получили закономерный результат:
  ```sql
   bombardier -c 125 -d 10s "localhost:80/user/snwu981936fee1f249f098965c6102f6e5f3"
  
  Statistics        Avg      Stdev        Max
  Reqs/sec      2483.29     1096.84    6962.58
  Latency       50.31ms   69.12ms      580.78ms
  ```
  - среднее время ответа улучшилось
  - нгинкс дает большую пропускную способность
    - Throughput (with nginx):     0.93MB/s  vs Throughput(without nginx):   593.15KB/s
  - сам умеет менеджить соединения и не ддосит бэкенд, сам отрубая соединение если оно слишком долго висит

- проверка с kill -9 инстанса при нагрузке:
  ```
  bombardier -c 125 -d 10s "localhost:80/user/snwu981936fee1f249f098965c6102f6e5f3"
  
  Statistics        Avg      Stdev        Max
  Reqs/sec      2910.42     932.85    5931.49
  Latency       65.30ms    88.97ms   577.63ms
  HTTP codes:
    1xx - 0, 2xx - 19205, 3xx - 0, 4xx - , 5xx - 1
  ```
  - во время внештатного завершения работы одного из инстансов мы получили всего 1 пятисотку
  - `192.168.65.1 - - [06/Jul/2024:12:19:26 +0000] "GET /user/snwu981936fee1f249f098965c6102f6e5f3 HTTP/1.1" 500 40 "-" "fasthttp"`
  - после этого nginx снял нагрузку с этого бэкенда и убрал его из пула выбора хоста при балансировке

- описана [конфигурация с haproxy](https://github.com/syth0le/social-network/blob/main/infra/haproxy/haproxy.cfg):
- добавлен контейнер с haproxy [compose](https://github.com/syth0le/social-network/blob/main/docker-compose.yaml#L19)
- переключен поход приложений в балансер, вместо прямых походов: [конфиг](https://github.com/syth0le/social-network/blob/main/cmd/social-network/local_config.yaml#L28)
- проведено нагрузочное тестирование в ходе которого было определено следующее:
  - максимальный RPS вырос до 10000, это говорит о том, что раньше мы упирались в базу и дожидались ответа от нее
  - при нештатном отключении одного из слейвов получили 96 500ок при 50000тыс запросах
    - это говорит о том, что haproxy не смог быстро убрать контейнер с бд из балансировки, из-за чего некоторые запросы шли в мертвый контейнер
    - сам haproxy написал следующее сообщение:
      ```
    [WARNING]  (8) : Server pgReadWrite/pg1 is DOWN, reason: Layer4 timeout, check duration: 3002ms. 2 active and 0 backup servers left. 94 sessions active, 0 requeued, 0 remaining in queue.
      ```